<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
    <title>AWS S3 File Upload</title>
    <script src="../demo/ceph.js"></script>
</head>

<body>
    <input id="file-chooser" type="file" />
    <button id="upload-button">Upload</button>
    <br/>
    <br/>
    <label id="progress" style="margin: 0 10 0 0"></label>
    <p id="results">
        <p></p>
        <script type="text/javascript">

            var fileChooser = document.getElementById('file-chooser');
            var button = document.getElementById('upload-button');
            var results = document.getElementById('results');
            var prog = document.getElementById('progress');

            AWS.config.update({  
                endpoint: '192.168.1.28:8989'
                // endpoint: '192.168.40.140:7480'
            });



            button.addEventListener('click', function () {

                var s3 = new AWS.S3({
                    accessKeyId: "i",
                    secretAccessKey: "like",
                    region: "it",
                    s3ForcePathStyle: true,
                    sslEnabled: false,
                    clientSideMonitoring: false,
                    sessionToken: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NTk3OTc0ODIsInVzZXJfbmFtZSI6InRlc3QiLCJhdXRob3JpdGllcyI6WyJhZG1pbiIsInVzZXIiXSwianRpIjoiYTk1MmE5MTUtNjZkOS00YjYwLTk5ODMtY2ViNWZjM2U5MDY4IiwiY2xpZW50X2lkIjoiY2xpZW50Iiwic2NvcGUiOlsiYWxsIiwic2VsZWN0Il19.xGPaJclHWdfhcKuyIuttYh4X7eakuO8dHhnJR5bx79E'
                });

                var file = fileChooser.files[0];
                if (file) {
                    results.innerHTML = '';
                    var params = {
                        Bucket: 'ceph', //必须是ceph,不然路由不到
                        Key: file.name, 
                        Body: file, 
                    };
                   var upload= s3.upload(params, {
                        queueSize: 3,                //分片上传并发队列,代表了能同时上传的分片数量
                        connectTimeout: 60*1008*10,  //连接 timeout时间
                        httpoptions:{
                            timeout: 60*100*10
                        }}).on('httpUploadProgress',function(e){
                            var precent= parseInt(e.loaded, 10)/ parseInt(e.total, 10);
                            precent=precent.toFixed(2) * 100;
                            setTimeout(function(){
                                prog.innerHTML='正在上传 Part：'+ e.part + '<br/>已上传：' +precent +"% <br/>";
                            },100)
                            console.log(e);
                        });
                    function sendupload(){
                        upload.send(function(err,data){
                            console.log(data);
                            console.log(err);
                            results.innerHTML = err ? 'ERROR!' : 'UPLOADED.';
                        })
                    }
                    sendupload();
                } else {
                    results.innerHTML = 'Nothing to upload.';
                }
            }, false);
        </script>
</body>

</html>